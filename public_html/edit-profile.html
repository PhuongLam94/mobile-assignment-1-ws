<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Take a date - Edit profile</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="bootstrap-3.3.6-dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="bootstrap-3.3.6-dist/css/bootstrap-theme.min.css">
        <link rel="stylesheet" href="font-awesome-4.5.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="bootstrap-3.3.6-dist/css/bootstrap.css" type="text/css"/>

        <script src="jquery-1.12.1.min.js"></script>

        <script src="bootstrap-3.3.6-dist/js/bootstrap.min.js"></script>

        <script>
            $().ready(function () {
                //var users1 = [{id: "1", username: "phuonglam", name: "Lam Minh Phuong", email: "abc@example.com", status: "1"}, {id: "2",username: "huongnguyen", name: "Nguyen Thi Huong", email: "abc2@example.com", status: "1"}, {id: "3", username: "huela", name: "La Van Hue", email: "abc3@example.com", status: "1"}, {id: "4", username: "tienngo", name: "Ngo Thuy Tien", email: "abc4@example.com", status: "1"}];
                if (!window.sessionStorage.userauth) {
                    window.location = "index.html";
                }
                var userAuth = window.sessionStorage.getItem("userauth");
                var userid = window.sessionStorage.getItem("userid");

                $(document).ajaxStart(function () {
                    $("#loading-image").show();
                    $("button").prop("disabled", true);
                });
                $(document).ajaxStop(function () {
                    $("#loading-image").hide();
                    $("button").prop("disabled", false);
                });
                $.ajax({
                    url: "http://localhost:8080/DatingApp-V1/getservice/getuser/" + userid,
                    type: "GET",
                    xhrFields: {
                        withCredentials: true
                    },
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', 'Basic ' + btoa(userAuth));
                    },
                    success: function (data) {
                        if (!data.message.includes("You are not allowed")) {
                            $("#username").val(data.test);
                            $("#email").val(data.email);
                            $("#output").attr("src", data.avatar);
                            $("#name").val(data.name);
                            if (data.gender === 1) {
                                $("#female").prop("checked", true);
                            } else {
                                $("#male").prop("checked", true);
                            }
                            $("#birthday").val(data.birthday);
                            $("#phone-number").val(data.test2);
                            $("#address").val(data.address);
                            $("#height").val(data.height);
                            $("#weight").val(data.weight);
                        } else {
                            window.sessionStorage.clear();
                            window.location = "index.html";
                        }

                    }
                })
                $("#btnSubmit").click(function (event) {
                    event.preventDefault();
                    if (checkForm()) {
                        var userData = {
                            id: userid,
                            email: $("#email").val(),
                            username1: $("#username").val(),
                            name: $("#name").val(),
                            status: 1,
                            test2: $("#phone-number").val(),
                            address: $("#address").val(),
                            height: $("#height").val(),
                            weight: $("#weight").val(),
                            avatar: "",
                            gender: $("input[type='radio']:checked").val() === "female" ? 1 : 2,
                            birthday: $("#birthday").val() === "" ? null : $("#birthday").val(),
                            message: "",
                            test: $("#username").val(),
                        };
                        var formData = new FormData();
                        formData.append("image", $("#picture")[0].files[0]);
                        $.ajax({
                            url: "https://api.imgur.com/3/image",
                            type: "POST",
                            datatype: "json",
                            contentType: false,
                            processData: false,
                            headers: {
                                "Authorization": "Client-ID 142cd168e236fc9"
                            },
                            data: formData,
                            success: function (response) {
                                console.log(response);
                                userData.avatar = response.data.link;
                                $.ajax({
                                    url: "http://localhost:8080/DatingApp-V1/putservice/user/edit",
                                    type: "PUT",
                                    xhrFields: {
                                        withCredentials: true
                                    },
                                    contentType: "application/json",
                                    data: JSON.stringify(userData),
                                    beforeSend: function (xhr) {
                                        xhr.setRequestHeader('Authorization', 'Basic ' + btoa(userAuth));
                                    }
                                }).done(function (data) {
                                    if (data.message === "Successful") {
                                        window.alert("Info saved, click OK to go back to profile");
                                        window.location = "index.html";
                                    }
                                });
                            }
                        });

                    }

                });
                $("#btnBack").click(function(){
                    window.sessionStorage.setItem("currentuserid", userid);
                    window.location = "profile.html";
                })

            });
            var checkForm = function () {
                if ($("#name").val() === "") {
                    $("#msg").text("Please enter name!");
                    $("#msg").show();
                    setTimeout(function () {
                        $("#msg").hide()
                    }, 5000)
                    return false;
                }
                return true;
            }
            var openFile = function (event) {
                var input = event.target;
                var reader = new FileReader();
                reader.onload = function () {
                    var dataURL = reader.result;
                    var output = document.getElementById('output');
                    output.src = dataURL;
                };
                reader.readAsDataURL(input.files[0]);
            };


        </script>
    </head>
    <body>
        <div class="container">
            <div id="msg" style="color: red; font-weight: bold; display: none" align="center"></div>
            <div class="jumbotron">
                <h3 id="title">Edit profile</h3>
            </div>
            <form role="form">
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" class="form-control" id="username" style="float: left;" readonly>
                </div>
                <div class="form-group">
                    <label for="email">Email address:</label>
                    <input type="email" class="form-control" id="email" style="float: left;" readonly>
                </div>
                <div class="form-group">
                    <label for="pwd">Password:</label>
                    <button id="btnChangePassword">Change password</button>
                </div>
                <div class="form-group">
                    <label for="picture">Avatar: </label>
                    <div>
                        <img id='output' style="width: 91%; margin-top: 2px; height: 85px; width: 85px" class="main_img"
                             alt="" src=""/>
                    </div>
                    <div>
                        <input type="file" class="form-control" id="picture" accept="image/*" onchange='openFile(event)'>
                    </div>
                </div>
                <div class="form-group">
                    <label for="name">Name:</label>
                    <input type="text" class="form-control" id="name">
                </div>
                <div class="form-group">
                    <label for="female">Gender:</label>
                    <label class="radio-inline"><input type="radio" name="gender" id="female" value="female">Female</label>
                    <label class="radio-inline"><input type="radio" name="gender" id="male" value="male">Male</label>    
                </div>
                <div class="form-group">
                    <label for="birthday">Birthday:</label>
                    <input type='date' data-format="dd/MM/yyyy" class="form-control" id="birthday"/>

                </div>
                <div class="form-group">
                    <label for="phone-number">Phone number:</label>
                    <input type="text" class="form-control" id="phone-number">
                </div>
                <div class="form-group">
                    <label for="address">Address:</label>
                    <input type="text" class="form-control" id="address">
                </div>
                <div class="form-group">
                    <label for="height">Height:</label>
                    <input type="text" class="form-control" id="height">
                </div>
                <div class="form-group">
                    <label for="weight">Weight</label>
                    <input type="text" class="form-control" id="weight">
                </div>

                <div align="right" style="float: right;">
                    <button class="btn btn-primary" id="btnSubmit">Save</button>
                    <button class="btn btn-success" id="btnBack">Back</button>
                </div>
                <div  id="loading-image" align="center" style="display: none; float: right">
                    <img style="height: 40px; width: 40px" alt="loading" src="Resource/loading_spinner.gif" />
                </div>
            </form>

        </div>

    </body>
</html>
